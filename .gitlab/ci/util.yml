.export_toolchain_snippet: &export_toolchain_snippet |
  echo "TOOLCHAIN_PREFIX: ${TOOLCHAIN_PREFIX}"
  echo "ESP_TOOLCHAIN: ${ESP_TOOLCHAIN}"
  echo "ESP_GDB_TOOLCHAIN: ${ESP_GDB_TOOLCHAIN}"
  if [ ! -z "$ESP_TOOLCHAIN" ]; then
    export PATH=${HOME}/.espressif/tools/${TOOLCHAIN_PREFIX}-elf/${ESP_TOOLCHAIN}/${TOOLCHAIN_PREFIX}-elf/bin:${PATH}
  fi
  if [ ! -z "$ESP_GDB_TOOLCHAIN" ]; then
    export PATH=${HOME}/.espressif/tools/${ESP_GDB_TOOLCHAIN}/bin:${PATH}
  fi
  if [ ! -z "$ESP_GCOV_TOOLCHAIN" ]; then
    wget --no-cache --no-verbose https://dl.espressif.com/dl/${ESP_TOOLCHAIN}-gcov.tar.gz
    tar -xvf ${ESP_TOOLCHAIN}-gcov.tar.gz
    export PATH=${ESP_GCOV_TOOLCHAIN}/${TOOLCHAIN_PREFIX}-elf/bin:${PATH}
  fi
.export_toolchain:
  script:
    - *export_toolchain_snippet

.run_tests_linux_snippet: &run_tests_linux_snippet |
  ARCHIVE_NAME=$(cat ${DIST_ART_DIR}/dist_name_${PLATFORM_NAME})
  tar -C ${TEST_RUN_DIR} -x -m -f ${DIST_ART_DIR}/${ARCHIVE_NAME}
  export DIST_DIR=${PWD}/${TEST_RUN_DIR}/${DIST_INSTALLED_DIR}
  export PYTHONPATH=$PWD/${TEST_RUN_DIR}:$PWD/testing/esp/py_debug_backend
  echo "CHIP_TEST_TOOLCHAIN: ${CHIP_TEST_TOOLCHAIN}"
  testing/esp/run_tests.py -o $DIST_DIR/bin/openocd -s $DIST_DIR/share/openocd/scripts -a $PWD/$TEST_RUN_DIR -t ${CHIP_TEST_TOOLCHAIN}-elf- -d 4 -l $PWD/$TEST_RUN_DIR/debug_backend_tests.log -tr x -to $PWD/$TEST_RUN_DIR/results $TEST_RUN_EXTRA_OPTS -c "${OOCD_CMDS}"

.run_tests_linux:
  script:
    - *run_tests_linux_snippet

.copy_nuttx_files_snippet: &copy_nuttx_files_snippet |
  mv nuttx.merged.bin $TEST_RUN_DIR/$NUTTX_APP_NAME/$NUTTX_APP_NAME.bin
  mv nuttx $TEST_RUN_DIR/$NUTTX_APP_NAME/$NUTTX_APP_NAME.elf

.copy_nuttx_files:
  script:
    - *copy_nuttx_files_snippet
